openapi: 3.1.0
info:
  title: Salamander Detection API
  description: 'API REST pour détecter et cropper des salamandres dans des images
    en utilisant un modèle YOLO custom.


    ## Fonctionnalités

    - Détection automatique de salamandres avec YOLO

    - Cropping intelligent centré sur la salamandre détectée

    - Réponse en base64 pour faciliter l''utilisation côté frontend

    - Support CORS pour intégration avec Next.js/Vercel


    ## Utilisation

    1. Envoyez une image via POST /crop-salamander

    2. Recevez la détection avec bounding box et image croppée en base64

    3. Utilisez l''image croppée directement dans votre frontend

    '
  version: 0.1.0
  contact:
    name: Cédric Jimenez
  license:
    name: MIT
paths:
  /:
    get:
      summary: Root
      description: Root endpoint with API information.
      operationId: root__get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /health:
    get:
      summary: Health Check
      description: Health check endpoint.
      operationId: health_check_health_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /crop-salamander:
    post:
      summary: Crop Salamander
      description: "Detect and crop a salamander from an uploaded image.\n\nArgs:\n\
        \    file: Image file (JPEG, PNG, etc.)\n    confidence: Confidence threshold\
        \ for detection (0.0 to 1.0)\n    return_base64: Whether to return the cropped\
        \ image as base64 encoded string\n    image_format: Output format (JPEG or\
        \ PNG). JPEG is 10-20x faster than PNG.\n    image_quality: JPEG quality (1-95).\
        \ Lower = faster but lower quality.\n    max_size: Max dimension for detection.\
        \ Images larger than this will be resized\n              for faster detection.\
        \ The crop is done on the original full-size image.\n\nReturns:\n    DetectionResponse\
        \ with detection results and optionally the cropped image"
      operationId: crop_salamander_crop_salamander_post
      parameters:
      - name: confidence
        in: query
        required: false
        schema:
          type: number
          maximum: 1.0
          minimum: 0.0
          description: Confidence threshold for detection
          default: 0.25
          title: Confidence
        description: Confidence threshold for detection
      - name: return_base64
        in: query
        required: false
        schema:
          type: boolean
          description: Whether to return the cropped image as base64
          default: true
          title: Return Base64
        description: Whether to return the cropped image as base64
      - name: image_format
        in: query
        required: false
        schema:
          type: string
          description: Output image format (JPEG or PNG). JPEG is much faster.
          default: JPEG
          title: Image Format
        description: Output image format (JPEG or PNG). JPEG is much faster.
      - name: image_quality
        in: query
        required: false
        schema:
          type: integer
          maximum: 95
          minimum: 1
          description: JPEG quality (1-95, only used for JPEG format)
          default: 85
          title: Image Quality
        description: JPEG quality (1-95, only used for JPEG format)
      - name: max_size
        in: query
        required: false
        schema:
          type: integer
          maximum: 4096
          minimum: 320
          description: Max dimension for detection (image resized if larger). Smaller
            = faster.
          default: 1280
          title: Max Size
        description: Max dimension for detection (image resized if larger). Smaller
          = faster.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/Body_crop_salamander_crop_salamander_post'
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetectionResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /segment-salamander:
    post:
      summary: Segment Salamander
      description: "Segment a salamander from an uploaded image using YOLO instance\
        \ segmentation.\n\nThis endpoint provides precise mask-based cropping that\
        \ removes the background,\nunlike /crop-salamander which returns a rectangular\
        \ crop with background included.\n\nArgs:\n    file: Image file (JPEG, PNG,\
        \ etc.)\n    confidence: Confidence threshold for detection (0.0 to 1.0)\n\
        \    background: Background color for the segmented image (gray, white, black)\n\
        \    image_format: Output format (JPEG or PNG). JPEG is faster.\n    image_quality:\
        \ JPEG quality (1-95). Lower = faster but lower quality.\n\nReturns:\n   \
        \ SegmentationResponse with segmentation results and the masked image"
      operationId: segment_salamander_segment_salamander_post
      parameters:
      - name: confidence
        in: query
        required: false
        schema:
          type: number
          maximum: 1.0
          minimum: 0.0
          description: Confidence threshold for detection
          default: 0.25
          title: Confidence
        description: Confidence threshold for detection
      - name: background
        in: query
        required: false
        schema:
          type: string
          description: 'Background color: gray, white, or black'
          default: gray
          title: Background
        description: 'Background color: gray, white, or black'
      - name: image_format
        in: query
        required: false
        schema:
          type: string
          description: Output image format (JPEG or PNG). JPEG is much faster.
          default: JPEG
          title: Image Format
        description: Output image format (JPEG or PNG). JPEG is much faster.
      - name: image_quality
        in: query
        required: false
        schema:
          type: integer
          maximum: 95
          minimum: 1
          description: JPEG quality (1-95, only used for JPEG format)
          default: 85
          title: Image Quality
        description: JPEG quality (1-95, only used for JPEG format)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/Body_segment_salamander_segment_salamander_post'
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SegmentationResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /model-info:
    get:
      summary: Model Info
      description: Get information about the loaded models.
      operationId: model_info_model_info_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema: {}
  /embed:
    post:
      summary: Embed Image
      description: "Extract a DINOv2 embedding vector from a salamander image.\n\n\
        The embedding can be stored in a vector database (e.g., pgvector)\nfor similarity\
        \ search to find candidate matches.\n\nArgs:\n    file: Segmented salamander\
        \ image (PNG with transparency recommended)\n\nReturns:\n    EmbeddingResponse\
        \ with the normalized embedding vector (384D)"
      operationId: embed_image_embed_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/Body_embed_image_embed_post'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /verify:
    post:
      summary: Verify Images
      description: "Verify if a query image matches any candidate images using SIFT.\n\
        \nThis endpoint performs detailed geometric matching using SIFT keypoints\n\
        and RANSAC filtering. Use this after retrieving candidates from a\nvector\
        \ database to confirm matches.\n\nArgs:\n    query: The query image (new salamander\
        \ observation)\n    candidates: List of candidate images to compare against\n\
        \nReturns:\n    VerificationResponse with results sorted by similarity score"
      operationId: verify_images_verify_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/Body_verify_images_verify_post'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
components:
  schemas:
    Body_crop_salamander_crop_salamander_post:
      properties:
        file:
          type: string
          format: binary
          title: File
          description: Image file containing a salamander
      type: object
      required:
      - file
      title: Body_crop_salamander_crop_salamander_post
    Body_embed_image_embed_post:
      properties:
        file:
          type: string
          format: binary
          title: File
          description: Segmented salamander image
      type: object
      required:
      - file
      title: Body_embed_image_embed_post
    Body_segment_salamander_segment_salamander_post:
      properties:
        file:
          type: string
          format: binary
          title: File
          description: Image file containing a salamander
      type: object
      required:
      - file
      title: Body_segment_salamander_segment_salamander_post
    Body_verify_images_verify_post:
      properties:
        query:
          type: string
          format: binary
          title: Query
          description: Query image (the new observation)
        candidates:
          items:
            type: string
            format: binary
          type: array
          title: Candidates
          description: Candidate images to compare against
      type: object
      required:
      - query
      - candidates
      title: Body_verify_images_verify_post
    BoundingBox:
      properties:
        x1:
          type: number
          title: X1
          description: Top-left x coordinate
        y1:
          type: number
          title: Y1
          description: Top-left y coordinate
        x2:
          type: number
          title: X2
          description: Bottom-right x coordinate
        y2:
          type: number
          title: Y2
          description: Bottom-right y coordinate
        confidence:
          type: number
          maximum: 1.0
          minimum: 0.0
          title: Confidence
          description: Detection confidence score
      type: object
      required:
      - x1
      - y1
      - x2
      - y2
      - confidence
      title: BoundingBox
      description: Bounding box coordinates.
    DetectionResponse:
      properties:
        success:
          type: boolean
          title: Success
          description: Whether detection was successful
        message:
          type: string
          title: Message
          description: Status message
        detected:
          type: boolean
          title: Detected
          description: Whether a salamander was detected
        bounding_box:
          anyOf:
          - $ref: '#/components/schemas/BoundingBox'
          - type: 'null'
          description: Bounding box of detected salamander
        cropped_image:
          anyOf:
          - type: string
          - type: 'null'
          title: Cropped Image
          description: Base64 encoded cropped image
        original_width:
          type: integer
          title: Original Width
          description: Original image width
        original_height:
          type: integer
          title: Original Height
          description: Original image height
      type: object
      required:
      - success
      - message
      - detected
      - original_width
      - original_height
      title: DetectionResponse
      description: Response model for salamander detection.
    EmbeddingResponse:
      properties:
        success:
          type: boolean
          title: Success
          description: Whether extraction was successful
        message:
          type: string
          title: Message
          description: Status message
        embedding:
          anyOf:
          - items:
              type: number
            type: array
          - type: 'null'
          title: Embedding
          description: Normalized embedding vector
        embedding_dim:
          type: integer
          title: Embedding Dim
          description: Embedding dimension
        model:
          type: string
          title: Model
          description: Model used for extraction
      type: object
      required:
      - success
      - message
      - embedding_dim
      - model
      title: EmbeddingResponse
      description: Response model for embedding extraction.
    HTTPValidationError:
      properties:
        detail:
          items:
            $ref: '#/components/schemas/ValidationError'
          type: array
          title: Detail
      type: object
      title: HTTPValidationError
    HealthResponse:
      properties:
        status:
          type: string
          title: Status
          description: Service status
        yolo_loaded:
          type: boolean
          title: Yolo Loaded
          description: Whether YOLO model is loaded
        segment_loaded:
          type: boolean
          title: Segment Loaded
          description: Whether segmentation model is loaded
          default: false
        embedder_loaded:
          type: boolean
          title: Embedder Loaded
          description: Whether DINOv2 embedder is loaded
          default: false
        version:
          type: string
          title: Version
          description: API version
      type: object
      required:
      - status
      - yolo_loaded
      - version
      title: HealthResponse
      description: Health check response.
    SegmentationResponse:
      properties:
        success:
          type: boolean
          title: Success
          description: Whether segmentation was successful
        message:
          type: string
          title: Message
          description: Status message
        detected:
          type: boolean
          title: Detected
          description: Whether a salamander was detected
        bounding_box:
          anyOf:
          - $ref: '#/components/schemas/BoundingBox'
          - type: 'null'
          description: Bounding box of detected salamander
        segmented_image:
          anyOf:
          - type: string
          - type: 'null'
          title: Segmented Image
          description: Base64 encoded segmented image with background removed
        original_width:
          type: integer
          title: Original Width
          description: Original image width
        original_height:
          type: integer
          title: Original Height
          description: Original image height
        background_color:
          type: string
          title: Background Color
          description: Background color used (gray, white, black)
      type: object
      required:
      - success
      - message
      - detected
      - original_width
      - original_height
      - background_color
      title: SegmentationResponse
      description: Response model for salamander segmentation.
    ValidationError:
      properties:
        loc:
          items:
            anyOf:
            - type: string
            - type: integer
          type: array
          title: Location
        msg:
          type: string
          title: Message
        type:
          type: string
          title: Error Type
      type: object
      required:
      - loc
      - msg
      - type
      title: ValidationError
    VerificationResponse:
      properties:
        success:
          type: boolean
          title: Success
          description: Whether verification was successful
        message:
          type: string
          title: Message
          description: Status message
        results:
          items:
            $ref: '#/components/schemas/VerificationResult'
          type: array
          title: Results
          description: Verification results sorted by score
      type: object
      required:
      - success
      - message
      title: VerificationResponse
      description: Response model for SIFT verification.
    VerificationResult:
      properties:
        candidate_index:
          type: integer
          title: Candidate Index
          description: Index of the candidate image
        is_same:
          type: boolean
          title: Is Same
          description: Whether likely the same individual
        score:
          type: number
          title: Score
          description: Similarity score
        confidence:
          type: string
          title: Confidence
          description: 'Confidence level: low, medium, high'
        matches:
          type: integer
          title: Matches
          description: Number of raw SIFT matches
        inliers:
          type: integer
          title: Inliers
          description: Number of RANSAC inliers
      type: object
      required:
      - candidate_index
      - is_same
      - score
      - confidence
      - matches
      - inliers
      title: VerificationResult
      description: Result of a single verification.
servers:
- url: http://localhost:8000
  description: Serveur de développement local
- url: https://your-api.railway.app
  description: Serveur de production (Railway)
